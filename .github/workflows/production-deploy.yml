name: Production Deploy

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  # Run all tests before deploying
  run-tests:
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  # Deploy to production
  deploy-production:
    runs-on: ubuntu-latest
    needs: run-tests
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://trackflow.app
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18.x
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci

    - name: Build frontend for production
      run: |
        cd frontend
        npm run build
      env:
        REACT_APP_API_URL: ${{ secrets.PRODUCTION_API_URL }}
        REACT_APP_ENVIRONMENT: production

    - name: Install backend dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run database migrations
      run: |
        cd backend
        python -c "
        from database import engine
        from models import Base
        Base.metadata.create_all(bind=engine)
        "
      env:
        DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
        SECRET_KEY: ${{ secrets.PRODUCTION_SECRET_KEY }}

    - name: Deploy to Railway (Backend)
      run: |
        pip install railway
        railway login --token ${{ secrets.RAILWAY_TOKEN }}
        cd backend
        railway up
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

    - name: Deploy to Netlify (Frontend)
      uses: nwtgck/actions-netlify@v2.1
      with:
        publish-dir: './frontend/build'
        production-branch: main
        production-deploy: true
        github-token: ${{ secrets.GITHUB_TOKEN }}
        deploy-message: "Deploy from GitHub Actions"
        enable-pull-request-comment: false
        enable-commit-comment: true
        overwrites-pull-request-comment: true
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

    - name: Health check
      run: |
        sleep 30
        curl -f ${{ secrets.PRODUCTION_API_URL }}/health || exit 1
        curl -f https://trackflow.app || exit 1

    - name: Notify deployment success
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: "‚úÖ Production deployment successful!"
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      if: success()

    - name: Notify deployment failure
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: "‚ùå Production deployment failed!"
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      if: failure()

  # Rollback on failure
  rollback:
    runs-on: ubuntu-latest
    needs: deploy-production
    if: failure()
    environment:
      name: production
    
    steps:
    - name: Rollback deployment
      run: |
        echo "Rolling back to previous version..."
        # Add rollback logic here
        
    - name: Notify rollback
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            text: "üîÑ Production rollback initiated due to deployment failure",
            color: "warning"
          }
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # Post-deployment tests
  post-deployment-tests:
    runs-on: ubuntu-latest
    needs: deploy-production
    if: success()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install test dependencies
      run: |
        pip install pytest requests

    - name: Run smoke tests
      run: |
        python -c "
        import requests
        import time
        
        # Wait for deployment to be ready
        time.sleep(60)
        
        # Test API health
        response = requests.get('${{ secrets.PRODUCTION_API_URL }}/health')
        assert response.status_code == 200
        
        # Test frontend
        response = requests.get('https://trackflow.app')
        assert response.status_code == 200
        
        print('‚úÖ Smoke tests passed!')
        "

    - name: Run performance check
      run: |
        python -c "
        import requests
        import time
        
        start_time = time.time()
        response = requests.get('${{ secrets.PRODUCTION_API_URL }}/songs')
        end_time = time.time()
        
        response_time = end_time - start_time
        print(f'API response time: {response_time:.2f}s')
        
        if response_time > 5.0:
            print('‚ö†Ô∏è API response time is slow')
            exit(1)
        else:
            print('‚úÖ API performance is good')
        "

    - name: Update deployment status
      run: |
        echo "Deployment completed successfully with post-deployment validation"